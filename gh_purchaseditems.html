<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sold Items - Greenhills</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    body, html {
      height: 100%;
      background:
        linear-gradient(rgba(0, 0, 0, 0.9), #ffffff9a, rgba(109, 20, 20, 0.9)),
        url('bg.png') no-repeat center center fixed;
      background-size: cover;
    }

    header {
      background-color: #800000;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .logo-container { display: flex; align-items: center; gap: 2rem; }
    .logo-container img { height: 80px; width: auto; }
    .logo-container h1 { font-size: 2rem; font-weight: 700; }
    .branch-name { font-size: 1.3rem; font-weight: 600; color: #ffffff; }
    .nav-buttons { display: flex; gap: 2rem; flex-wrap: wrap; }
    .nav-buttons a {
      background-color: #ffffff;
      color: #800000;
      padding: 0.6rem 1.3rem;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    .nav-buttons a:hover {
      background: linear-gradient(135deg, #f55a1d 0%, #f5c21d 100%);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .main-content {
      padding: 3rem;
      height: calc(100vh - 112px);
      display: flex;
      flex-direction: column;
    }
    .form-container {
      background-color: white;
      border-radius: 2rem;
      padding: 1.5rem;
      box-shadow: 0 8px 30px rgba(44, 12, 0, 0.3);
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    h2 { color: #800000; text-align: center; margin-bottom: 0.75rem; }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }
    .filters {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filters input {
      padding: 0.5rem 0.9rem;
      border-radius: 1rem;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .btn-light {
      background:#ccc; color:#333; padding:0.5rem 0.9rem; border:none; border-radius:1rem; font-weight:600; cursor:pointer;
    }
    .btn-light:hover { filter: brightness(0.95); }
    .btn-action { background:#800000; color:#fff; padding:0.4rem 0.8rem; border:none; border-radius:0.5rem; cursor:pointer; }
    .btn-action:hover { background:#a00000; }

    .table-wrapper {
      border: 1px solid #ddd;
      border-radius: 1rem;
      overflow: hidden;
      background: #fff;
      display: flex;
      flex-direction: column;
      min-height: 0;
      flex: 1 1 auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #800000;
      color: #fff;
      z-index: 1;
    }
    th, td { border: 1px solid #ccc; padding: 0.6rem; text-align: center; }
    td.items-list { text-align: left; }
    td.no-data { text-align: center; font-style: italic; color: #666; }

    .table-scroll {
      overflow-y: auto;
      max-height: 300px; /* scroll only inside table */
    }

    @media (max-width: 640px) {
      .main-content { padding: 1.5rem; }
      .form-container { border-radius: 1.25rem; padding: 1rem; }
      .logo-container h1 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo-container">
      <img src="logo.png" alt="ERestore Logo">
      <h1>ERestore Leatherworks <span class="branch-name">| Greenhills</span></h1>
    </div>
    <nav class="nav-buttons">
      <a href="gh.html">Homepage</a>
      <a href="gh_announcement.html">Announcements</a>
      <a href="gh_report.html">Reports</a>
      <a href="gh_appointment.html">Appointments</a>
      <a href="gh_customerlist.html">Customers</a>
      <a href="gh_attendance.html">Attendance</a>
      <a href="gh_expenses.html">Expenses</a>
    </nav>
  </header>

  <div class="main-content">
    <!-- Only filtered sales -->
    <div class="form-container">
      <h2>Sold Items Record</h2>

      <div class="toolbar">
        <div class="filters">
          <input type="date" id="startDate" />
          <span style="opacity:.7;">to</span>
          <input type="date" id="endDate" />
          <input type="text" id="searchCustomer" placeholder="Search customer name..." />
          <button id="clearFiltersBtn" class="btn-light">Clear</button>
        </div>
      </div>

      <div class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Grand Total (₱)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="soldTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tableBody = document.getElementById('soldTableBody');
    const sdEl = document.getElementById('startDate');
    const edEl = document.getElementById('endDate');
    const searchEl = document.getElementById('searchCustomer');
    const clearBtn = document.getElementById('clearFiltersBtn');

    const sales = JSON.parse(localStorage.getItem('gh_soldItems') || '[]');

    function inRange(dateStr, startRange, endRange) {
      if (!dateStr) return false;
      const d = new Date(dateStr);
      if (isNaN(d)) return false;
      let ok = true;
      if (startRange) ok = ok && d >= startRange;
      if (endRange)   ok = ok && d <= endRange;
      return ok;
    }

    function renderTable(list, target) {
      if (!list.length) {
        target.innerHTML = '<tr><td colspan="5" class="no-data">No sales recorded yet.</td></tr>';
        return;
      }
      target.innerHTML = '';
      list.forEach((sale, index) => {
        const itemList = (sale.items || []).map(i =>
          `• ${i.desc ?? i.description} (x${i.qty ?? i.quantity}) - ₱${(i.total ?? i.lineTotal ?? 0).toFixed(2)}`
        ).join('<br>');

        const row = document.createElement('tr');
        const grand = Number(sale.grandTotal ?? 0);
        row.innerHTML = `
          <td>${sale.date || '—'}</td>
          <td>${sale.customer || '—'}</td>
          <td class="items-list">${itemList || '—'}</td>
          <td>₱${grand.toFixed(2)}</td>
          <td><button class="btn-action" onclick="printReceipt(${index})">Receipt</button></td>
        `;
        target.appendChild(row);
      });
    }

    function applyFilters() {
      const sdVal = sdEl.value;
      const edVal = edEl.value;
      const searchVal = searchEl.value.trim().toLowerCase();
      let startRange = null, endRange = null;

      if (sdVal) { startRange = new Date(sdVal); startRange.setHours(0,0,0,0); }
      if (edVal) { endRange   = new Date(edVal); endRange.setHours(23,59,59,999); }

      const filtered = sales.filter(s => {
        const matchDate = inRange(s.date, startRange, endRange);
        const matchCustomer = !searchVal || (s.customer || '').toLowerCase().includes(searchVal);
        return matchDate && matchCustomer;
      });

      renderTable(filtered.length ? filtered : [], tableBody);
    }

    function printReceipt(index) {
      const sale = sales[index];
      if (!sale) return;

      const itemList = (sale.items || []).map(i =>
        `• ${i.desc ?? i.description} (x${i.qty ?? i.quantity}) - ₱${(i.total ?? i.lineTotal ?? 0).toFixed(2)}`
      ).join('<br>');

      const html = `
        <html>
          <head>
            <title>Receipt</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
              .receipt-container {
                width: 100%;
                height: 50%;
                padding: 20px;
                box-sizing: border-box;
              }
              h2 { text-align: center; color: #800000; margin-top: 0; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
              .total { font-weight: bold; text-align: right; }

              @media print {
                @page { size: A4 portrait; margin: 1cm; }
                .receipt-container { height: 50vh; page-break-after: avoid; }
              }
            </style>
          </head>
          <body>
            <div class="receipt-container">
              <h2>ERestore Leatherworks - Greenhills</h2>
              <p><strong>Date:</strong> ${sale.date}</p>
              <p><strong>Customer:</strong> ${sale.customer}</p>
              <table>
                <tr><th>Items</th></tr>
                <tr><td>${itemList}</td></tr>
              </table>
              <p class="total">Grand Total: ₱${Number(sale.grandTotal ?? 0).toFixed(2)}</p>
              <p style="text-align:center; margin-top:30px;">Thank you for your purchase!</p>
            </div>
          </body>
        </html>
      `;

      const w = window.open('', '_blank', 'width=700,height=800');
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 300);
    }

    sdEl.addEventListener('change', applyFilters);
    edEl.addEventListener('change', applyFilters);
    searchEl.addEventListener('input', applyFilters);
    clearBtn.addEventListener('click', () => {
      sdEl.value = '';
      edEl.value = '';
      searchEl.value = '';
      applyFilters();
    });

    // initial render
    renderTable(sales, tableBody);
  </script>
</body>
</html>
