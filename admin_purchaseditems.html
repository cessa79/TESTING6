<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> Overall Purchased Items - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
* { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
body, html {
  height: 100%;
  background:
    linear-gradient(rgba(0,0,0,0.9), #ffffff9a, rgba(109,20,20,0.9)),
    url('bg.png') no-repeat center center fixed;
  background-size: cover;
}
header {
  background-color: #800000;
  color: white;
  padding: 1rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo-container { display: flex; align-items: center; gap: 2rem; }
.logo-container img { height: 80px; width: auto; }
.logo-container h1 { font-size: 2rem; font-weight: 700; }
.branch-name { font-size: 1.3rem; font-weight: 600; color: #fff; }
.nav-buttons { display: flex; gap: 2rem; flex-wrap: wrap; }
.nav-buttons a {
  background-color: #fff;
  color: #800000;
  padding: 0.6rem 1.3rem;
  border-radius: 50px;
  text-decoration: none;
  font-weight: 600;
}
.nav-buttons a:hover {
  background: linear-gradient(135deg, #f55a1d 0%, #f5c21d 100%);
  color: #fff;
}
.main-content { padding: 3rem; display: flex; justify-content: center; }
.form-container {
  background: #fff;
  border-radius: 2rem;
  padding: 1.5rem;
  box-shadow: 0 8px 30px rgba(44, 12, 0, 0.3);
  max-width: 1200px;
  width: 100%;
}
h2 { color: #800000; text-align: center; margin-bottom: 1rem; }
.toolbar { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
.filters { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.filters input { padding: 0.5rem 0.8rem; border-radius: 1rem; border: 1px solid #ccc; }
.btn-light, .btn-print {
  padding:0.5rem 0.8rem; border:none; border-radius:1rem; cursor:pointer;
}
.btn-light { background:#ccc; color:#333; }
.btn-print { background:#800000; color:#fff; }
.btn-light:hover { filter: brightness(0.95); }
.btn-print:hover { background:#a00000; }
.table-wrapper { border: 1px solid #ddd; border-radius: 1rem; overflow: hidden; background: #fff; }
table { width: 100%; border-collapse: collapse; }
thead th {
  position: sticky;
  top: 0;
  background: #800000;
  color: #fff;
}
th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
td.items-list { text-align: left; }
td.no-data { text-align: center; font-style: italic; color: #666; }
.table-scroll { overflow-y: auto; max-height: 400px; }

/* Print Styles */
@media print {
  header, .toolbar { display: none !important; }
  body { background: #fff; }
  .form-container { box-shadow: none; border-radius: 0; }
  .table-scroll { max-height: unset; overflow: visible; }
}
</style>
</head>
<body>

<header>
  <div class="logo-container">
    <img src="logo.png" alt="ERestore Logo">
    <h1>ERestore Leatherworks <span class="branch-name">| Overall Purchased Items</span></h1>
  </div>
  <nav class="nav-buttons">
    <a href="admin.html">Home</a>
    <a href="admin_reports.html">Reports</a>
    <a href="admin_appointments.html">Appointments</a>
    <a href="admin_customerlist.html">Customers</a>
    <a href="admin_attendance.html">Attendance</a>
    <a href="admin_expenses.html">Expenses</a>
  </nav>
</header>

<div class="main-content">
  <div class="form-container">
    <h2>Sold Items Record</h2>
    <div class="toolbar">
      <div class="filters">
        <input type="date" id="startDate">
        <span style="opacity:.7;">to</span>
        <input type="date" id="endDate">
        <input type="text" id="searchCustomer" placeholder="Search customer name...">
        <button id="clearFiltersBtn" class="btn-light">Clear</button>
        <button id="printBtn" class="btn-print">Print</button>
      </div>
    </div>

    <div class="table-wrapper">
      <div class="table-scroll">
        <table id="salesTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Customer / Branch</th>
              <th>Items</th>
              <th>Grand Total (â‚±)</th>
            </tr>
          </thead>
          <tbody id="soldTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAWUoFS5NNcxUa5Pu57q7jEXLqEeKpJsg",
  authDomain: "erestore-leatherworks.firebaseapp.com",
  projectId: "erestore-leatherworks",
  storageBucket: "erestore-leatherworks.appspot.com",
  messagingSenderId: "727698074030",
  appId: "1:727698074030:web:58870b6be96934e71c003f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tableBody = document.getElementById('soldTableBody');
const sdEl = document.getElementById('startDate');
const edEl = document.getElementById('endDate');
const searchEl = document.getElementById('searchCustomer');
const clearBtn = document.getElementById('clearFiltersBtn');
const printBtn = document.getElementById('printBtn');

const branchCollections = [
  "gh_soldItems",
  "abreeza_soldItems",
  "lanang_soldItems",
  "bcd_soldItems",
  "gensan_soldItems",
  "cdo_soldItems",
  "mercedes_soldItems"
];

let salesData = [];

function formatDateField(dateField) {
  if (!dateField) return "-";
  if (dateField.seconds) {
    return new Date(dateField.seconds * 1000).toLocaleDateString();
  }
  const d = new Date(dateField);
  return isNaN(d) ? "-" : d.toLocaleDateString();
}

function inRange(dateField, startRange, endRange) {
  if (!dateField) return false;
  let d;
  if (dateField.seconds) {
    d = new Date(dateField.seconds * 1000);
  } else {
    d = new Date(dateField);
  }
  if (isNaN(d)) return false;
  let ok = true;
  if (startRange) ok = ok && d >= startRange;
  if (endRange) ok = ok && d <= endRange;
  return ok;
}

function renderTable(list) {
  if (!list.length) {
    tableBody.innerHTML = '<tr><td colspan="4" class="no-data">No sales recorded yet.</td></tr>';
    return;
  }
  tableBody.innerHTML = '';
  list.forEach(p => {
    const itemList = (p.items || []).map(i =>
      `â€¢ ${i.desc ?? i.description ?? '-'} (x${i.qty ?? i.quantity ?? 1}) - â‚±${((i.total ?? i.lineTotal) ?? 0).toFixed(2)}`
    ).join('<br>');

    const grandTotal = Number(
      p.totalCost ?? p.grandTotal ?? p.total ?? p.totalAmount ?? 0
    ).toFixed(2);

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDateField(p.date)}</td>
      <td>${p.customer ?? p.customerName ?? '-'}<br><small style="color:#800000;">(${p.branch})</small></td>
      <td class="items-list">${itemList || '-'}</td>
      <td>â‚±${grandTotal}</td>
    `;
    tableBody.appendChild(row);
  });
}

function applyFilters() {
  const sdVal = sdEl.value;
  const edVal = edEl.value;
  const searchVal = searchEl.value.trim().toLowerCase();
  let startRange = sdVal ? new Date(sdVal) : null;
  let endRange   = edVal ? new Date(edVal) : null;
  if (startRange) startRange.setHours(0,0,0,0);
  if (endRange) endRange.setHours(23,59,59,999);

  const filtered = salesData.filter(p => {
    const matchDate = inRange(p.date, startRange, endRange);
    const matchCustomer = !searchVal || (p.customer ?? p.customerName ?? '').toLowerCase().includes(searchVal);
    return matchDate && matchCustomer;
  });

  renderTable(filtered);
}

clearBtn.addEventListener('click', () => {
  sdEl.value = '';
  edEl.value = '';
  searchEl.value = '';
  applyFilters();
});

sdEl.addEventListener('change', applyFilters);
edEl.addEventListener('change', applyFilters);
searchEl.addEventListener('input', applyFilters);

// ðŸ”¹ Print only filtered table
printBtn.addEventListener('click', () => {
  window.print();
});

async function loadSales() {
  salesData = [];
  try {
    for (const branch of branchCollections) {
      const snap = await getDocs(collection(db, branch));
      snap.forEach(doc => {
        const data = doc.data();
        salesData.push({ ...data, branch });
      });
    }
    salesData.sort((a, b) => {
      const dA = a.date?.seconds ? new Date(a.date.seconds * 1000) : new Date(a.date);
      const dB = b.date?.seconds ? new Date(b.date.seconds * 1000) : new Date(b.date);
      return dB - dA;
    });
    renderTable(salesData);
  } catch(err) {
    console.error("Error fetching sales:", err);
    tableBody.innerHTML = '<tr><td colspan="4" class="no-data">Failed to load sales.</td></tr>';
  }
}

loadSales();
</script>

</body>
</html>

